#!/usr/bin/env python3
import tkinter as tk
import webbrowser
import ee
import subprocess
from tkinter import filedialog


def OpenUrl(url):
    webbrowser.open_new(url)


def enter(window, entry, pipe):
    string = entry.get()

    pipe.communicate(input=str.encode(f"{string}\n"))


def authenticate(window):
    pipe = subprocess.Popen(
        ["authenticate"], stdin=subprocess.PIPE, stdout=subprocess.PIPE
    )

    entry = tk.Entry(window, width=40)
    entry.focus_set()
    entry.pack(side="left")
    button_ok = tk.Button(
        window,
        text="Okay",
        width=20,
        command=lambda window=window, entry=entry, pipe=pipe: enter(
            window, entry, pipe
        ),
    ).pack(pady=20, side="left")


def MODIS_data():
    MODIS_data_window = tk.Tk()
    url = "https://sangwon.users.earthengine.app/view/seaicephenology"

    button_MODIS = tk.Button(
        MODIS_data_window,
        text="Access Google Earth Engine App",
        command=lambda aurl=url: OpenUrl(aurl),
    )
    button_MODIS.pack(side="top")

    button_authenticate = tk.Button(
        MODIS_data_window,
        text="Authenticate Google Earth Engine Account",
        command=lambda window=MODIS_data_window: authenticate(window),
    )
    button_authenticate.pack(side="top")


# Function for opening the
# file explorer window
def browseFiles(label):
    filename = filedialog.askopenfilename(
        initialdir="./",
        title="Select a File",
        filetypes=(("CSV files", "*.csv*"), ("all files", "*.*")),
    )

    label.configure(text="File Opened: " + filename)


def main():
    main_window = tk.Tk()
    main_window.geometry("1000x500")
    main_window.config(background="white")

    title_frame = tk.Frame(main_window, background="#D2E2FB", bd=1, relief="flat")
    title_frame.pack()

    title = tk.Label(
        title_frame,
        text="Sea Ice Phenology Detection\nby ICE Lab at University of Victoria",
        width=50,
        height=4,
        fg="black",
        font="50",
    )
    title.config(background="white")
    title.pack()

    button_MODIS = tk.Button(
        main_window, text="Retrieve MODIS data", command=MODIS_data
    )
    button_MODIS.pack(side="top")

    FE_frame = tk.Frame(main_window)

    label_file_explorer = tk.Label(FE_frame, text="File Opened: ", fg="blue")

    button_explore = tk.Button(
        FE_frame,
        text="Browse Files",
        command=lambda label=label_file_explorer: browseFiles(label),
    )
    FE_frame.pack(side="top")
    button_explore.pack(side="left")
    label_file_explorer.pack(side="left")

    button_exit = tk.Button(main_window, text="Exit", command=exit)
    button_exit.pack(side="top")

    main_window.mainloop()


if __name__ == "__main__":
    main()
